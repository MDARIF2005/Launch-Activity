{% extends "base.html" %}

{% block title %}Launch Result - Activity Launch App{% endblock %}

{% block extra_css %}
{% if type == "image" %}
<style>
    html,
    body {
        height: 100%;
        margin: 0;
        background: #000;
    }

    .navbar {
        display: none !important;
    }

    .fullscreen-image-wrapper {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
    }

    .fullscreen-image-wrapper img {
        max-width: 100vw;
        max-height: 100vh;
        width: auto;
        height: auto;
        object-fit: contain;
        /* show full image centered with possible side bars */
        image-rendering: auto;
        -ms-interpolation-mode: bicubic;
    }
</style>
{% endif %}
{% endblock %}

{% block content %}
{% if type == "image" %}
<!-- Full screen image/video display with celebration effect -->
<div class="fullscreen-image-wrapper">
    {% if image_path.endswith('.mp4') or image_path.endswith('.webm') or image_path.endswith('.ogg') %}
    <video src="{{ image_path }}" autoplay style="max-width:100vw; max-height:100vh;"></video>
    {% else %}
    <img src="{{ image_path }}" alt="Launched Image" style="max-width:100vw; max-height:100vh;">
    {% endif %}
    <canvas id="confetti-canvas"
        style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    window.onload = function () {
        confetti({
            particleCount: 200,
            spread: 90,
            origin: { y: 0.6 }
        });
    };
</script>
{% elif type == "file" %}
<div class="fullscreen-image-wrapper"
    style="background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;">

    {% set office_exts = ['.ppt', '.pptx', '.doc', '.docx', '.xls', '.xlsx', '.odt', '.ods', '.odp'] %}
    {% set is_office = false %}
    {% for ext in office_exts %}
    {% if file_path.lower().endswith(ext) %}{% set is_office = true %}{% endif %}
    {% endfor %}
    {% if image_exts|select('in', file_path.lower())|list %}
    <img src="{{ file_path.replace('\\','/') }}" alt="Image"
        style="max-width:90vw; max-height:80vh; margin-bottom:20px;" />
    {% elif video_exts|select('in', file_path.lower())|list %}
    <video src="{{ file_path.replace('\\','/') }}" autoplay
        style="max-width:90vw; max-height:80vh; margin-bottom:20px;"></video>
    {% elif file_path.endswith('.pdf') %}
    <embed src="{{ file_path.replace('\\','/') }}" type="application/pdf" width="90%" height="600px"
        style="border:1px solid #ccc; margin-bottom:20px;" />
    {% elif file_path.endswith('.txt') or file_path.endswith('.csv') %}
    <iframe src="{{ file_path.replace('\\','/') }}" width="90%" height="400px"
        style="border:1px solid #ccc; margin-bottom:20px;"></iframe>
    {% elif is_office %}
    <div
        style="width:90vw;max-width:1200px;height:70vh;margin:0 auto;position:relative;background:#222;border-radius:12px;box-shadow:0 2px 16px #0003;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <iframe id="office-viewer" src="https://docs.google.com/gview?url={{ file_url }}&embedded=true" width="100%"
            height="100%" style="min-height:500px;border:none;background:#222;"></iframe>
        <div id="office-fallback"
            style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:#222;align-items:center;justify-content:center;z-index:10;flex-direction:column;">
            <div style="color:#fff;font-size:1.5rem;margin-bottom:1rem;">No preview available for this file.</div>
        </div>
    </div>
    <script>
        // Fallback if Google Docs Viewer fails to load
        document.addEventListener('DOMContentLoaded', function () {
            var iframe = document.getElementById('office-viewer');
            var fallback = document.getElementById('office-fallback');
            if (iframe) {
                setTimeout(function () {
                    try {
                        var noPreview = iframe.contentDocument && iframe.contentDocument.body && iframe.contentDocument.body.innerText.includes('No preview available');
                        if (noPreview) {
                            fallback.style.display = 'flex';
                            iframe.style.display = 'none';
                        }
                    } catch (e) {
                        // Cross-origin, show fallback if iframe is blank after 3s
                        if (iframe && (!iframe.contentWindow || !iframe.contentWindow.length)) {
                            fallback.style.display = 'flex';
                            iframe.style.display = 'none';
                        }
                    }
                }, 3000);
            }
        });
    </script>
    {% elif file_path.startswith('https://docs.google.com/presentation') %}
    <!-- Google Slides embed -->
    <iframe src="{{ file_path.replace('/edit', '/embed') }}" frameborder="0" width="90%" height="600px" allowfullscreen
        style="background:#fff;"></iframe>
    {% else %}
    <div style="color:#fff;font-size:1.5rem;margin-bottom:1rem;">Preview not available. Please download the file to view
        it.</div>
    {% endif %}
    <a href="{{ file_path.replace('\\','/') }}" class="btn btn-success btn-lg" download>
        <i class="fas fa-download me-2"></i>Download File
    </a>
    <a href="{{ file_path.replace('\\','/') }}" class="btn btn-primary btn-lg" target="_blank" style="margin-top:10px;">
        <i class="fas fa-external-link-alt me-2"></i>Open File
    </a>
    <canvas id="confetti-canvas"
        style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    window.onload = function () {
        confetti({
            particleCount: 200,
            spread: 90,
            origin: { y: 0.6 }
        });
    };
</script>
{% else %}
<!-- Other content types with normal layout -->
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-success text-white text-center">
                <h2 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Launch Successful!
                </h2>
            </div>
            <div class="card-body p-4 text-center">
                {% if type == "website" %}
                <div class="mb-4">
                    <i class="fas fa-globe fa-5x text-primary mb-3"></i>
                    <h4>Website Launched</h4>
                    <p class="text-muted">{{ message }}</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        The website should have opened in your default browser.
                    </div>
                    <!-- Manual open fallback in case automatic opening is blocked -->
                    <div id="open-website-fallback" style="margin-top:12px;">
                        <a id="open-website-btn" href="{{ website_url }}" class="btn btn-primary btn-lg" target="_blank"
                            rel="noopener noreferrer" style="display:none;">
                            <i class="fas fa-external-link-alt me-2"></i>Open Website
                        </a>
                        <p id="open-website-note" class="text-muted" style="display:none;margin-top:8px;">If the website
                            did not open automatically, click the button above.</p>
                    </div>
                </div>
                <!-- Data holder for JS to pick up -->
                <div id="website-launch-data" data-url="{{ website_url }}" style="display:none;"></div>
                {% elif type == "file" %}
                <div class="mb-4">
                    <i class="fas fa-file fa-5x text-primary mb-3"></i>
                    <h4>File Ready</h4>
                    <p class="text-muted">File path: {{ file_path }}</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        The file is ready for access at the specified location.
                    </div>
                </div>
                {% elif type == "timer" %}
                <div class="mb-4">
                    <i class="fas fa-clock fa-5x text-primary mb-3"></i>
                    <h4>Launch Scheduled</h4>
                    <p class="text-muted">{{ message }}</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        The launch has been scheduled. Keep this page open until the scheduled time.
                    </div>
                </div>
                {% else %}
                <div class="mb-4">
                    <i class="fas fa-rocket fa-5x text-primary mb-3"></i>
                    <h4>Launch Executed</h4>
                    <p class="text-muted">Your configured launch has been successfully executed!</p>
                </div>
                {% endif %}

                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Configure New Launch
                    </a>
                </div>
            </div>
        </div>

        <!-- Launch Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Launch Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="border-end">
                            <h6 class="text-muted">Launch Type</h6>
                            <h4 class="text-primary">
                                {% if type == "website" %}
                                <i class="fas fa-globe"></i> Website
                                {% elif type == "file" %}
                                <i class="fas fa-file"></i> File
                                {% else %}
                                <i class="fas fa-rocket"></i> Custom
                                {% endif %}
                            </h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border-end">
                            <h6 class="text-muted">Status</h6>
                            <h4 class="text-success">
                                <i class="fas fa-check-circle"></i> Success
                            </h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Timestamp</h6>
                        <h4 class="text-info">
                            <i class="fas fa-clock"></i> <span id="launch-timestamp">--:--:--</span>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const now = new Date();
        const ts = document.getElementById('launch-timestamp');
        if (ts) ts.textContent = now.toLocaleTimeString();

        // Check for website launch data
        const launchData = document.getElementById('website-launch-data');
        if (launchData && launchData.dataset.url) {
            // Try to open the launched website in a new tab using multiple methods
            (function () {
                var url = launchData.dataset.url;
                // Function to try opening URL in new tab multiple ways
                function openNewTab() {
                    try {
                        // 1. Try window.open first (works if triggered by user gesture)
                        var w = window.open(url, '_blank');
                        if (w) return true;

                        // 2. Try creating and clicking a real link (some browsers allow this)
                        var a = document.createElement('a');
                        a.href = url;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.style.display = 'none';
                        document.body.appendChild(a);

                        // Use both click() and dispatchEvent for maximum compatibility
                        var clicked = false;
                        try {
                            a.click();
                            clicked = true;
                        } catch (e) { }
                        try {
                            var evt = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: true
                            });
                            a.dispatchEvent(evt);
                            clicked = true;
                        } catch (e) { }
                        document.body.removeChild(a);
                        if (clicked) return true;
                    } catch (e) { }
                    return false;
                }

                // Try to open in new tab; if that fails, navigate current tab as last resort
                if (!openNewTab()) {
                    try {
                        // Attempt to navigate current tab to ensure the URL opens automatically
                        window.location.href = url;
                    } catch (e) {
                        // If navigation is blocked for any reason, reveal manual button
                        var btn = document.getElementById('open-website-btn');
                        var note = document.getElementById('open-website-note');
                        if (btn) btn.style.display = 'inline-block';
                        if (note) note.style.display = 'block';
                    }
                }
            })();
        }
    });
</script>
{% endblock %}